# 异步图像生成功能需求确认文档

## 原始需求
**用户请求**: 支持异步生成图片

## 仓库上下文
- **项目类型**: JiMeng MCP 服务器，提供AI图像/视频生成API桥接
- **技术栈**: TypeScript, Node.js, MCP SDK 1.10.2
- **当前实现**: 同步 `generateImage` 函数，等待完整生成过程后返回URL

## 需求澄清过程

### 澄清轮次1 - 基础设计问题
**问题**:
1. 异步工作流设计（任务ID vs 回调 vs 流式）
2. 客户端集成方式（新工具 vs 扩展现有）
3. 状态管理存储位置
4. 进度跟踪需求
5. 结果交付方式
6. 使用场景优先级

**用户回答总结**:
- 基于任务ID（称为history ID）
- 扩展现有版本添加异步选项
- 内存存储任务状态
- 不需要实时进度更新
- 不需要状态管理
- 主要场景：多并发生成

### 澄清轮次2 - 关键架构调整
**用户重要澄清**:
- **无状态设计**: 不需要本地存储和状态管理
- **外部端点驱动**: history ID由外部API返回，格式由外部定义
- **无内存管理**: 不需要清理机制，不存储任何数据
- **纯转发模式**: MCP作为外部API的代理层

## 最终确认的需求规格

### 功能规格
1. **异步参数扩展**: 在现有 `generateImage` 工具中添加 `async: boolean` 参数
2. **History ID返回**: `async=true` 时调用外部异步端点，返回外部API提供的historyId
3. **结果查询工具**: 新增 `getImageResult` 工具，接收historyId查询外部端点结果
4. **向后兼容**: `async=false` 或未设置时保持现有同步行为

### 技术实现架构
1. **无状态设计**: 不存储任何本地状态或数据
2. **纯转发模式**: MCP服务器作为外部API的代理层
3. **外部管理**: historyId格式、生命周期完全由外部API管理
4. **错误处理**: 转发外部API的原始响应和错误信息

### API设计规格
```typescript
// generateImage 工具扩展
{
  // 现有参数保持不变
  filePath?: string[],
  prompt: string,
  model?: string,
  // ... 其他现有参数
  
  // 新增异步参数
  async?: boolean  // 默认false，保持向后兼容
}

// getImageResult 新工具
{
  historyId: string  // 从异步generateImage获取的ID
}
```

### 与现有代码库集成
- 扩展现有TypeScript MCP服务器架构
- 遵循现有的Zod参数验证模式
- 保持与现有错误处理一致性
- 无破坏性变更，完全向后兼容

## 需求质量评估

### 最终评分: 95/100
- **功能清晰度**: 28/30 ✅
- **技术特定性**: 25/25 ✅  
- **实现完整性**: 24/25 ✅
- **业务上下文**: 18/20 ✅

### 评估详情
**优势**:
- 架构简洁，无状态设计降低复杂度
- 外部端点驱动，充分利用现有API能力
- 向后兼容，零风险部署
- 支持多并发，满足业务需求

**实施准备度**: ✅ 已达到90+分实施标准

## 用户确认
**确认状态**: ✅ 用户已确认开始实施
**确认时间**: 2025-09-23
**确认方式**: 明确回复"是"

## 后续步骤
1. 技术规格生成
2. 代码实施
3. 质量评审
4. 测试（根据用户选择）